#### 目录介绍








### 04.网络请求异常处理
- 网络请求异常大概有哪些？
    - 第一种：访问接口异常，比如404，500等异常，出现这类异常，Retrofit会自动抛出异常。
    - 第二种：解析数据异常，数据体发生变化可能会导致这个问题。
    - 第三种：其他类型异常，比如服务器响应超时异常，链接失败异常，网络未连接异常等等。
    - 第四种：网络请求成功，但是服务器定义了异常状态，比如token失效，参数传递错误，或者统一给提示(这个地方比较拗口，比如购物app，你购买n件商品请求接口成功，code为200，但是服务器发现没有这么多商品，这个时候就会给你一个提示，然后客户端拿到这个进行吐司)
- 在获取数据的流程中，访问接口和解析数据时都有可能会出错，我们可以通过拦截器在这两层拦截错误。
    - 1.在访问接口时，我们不用设置拦截器，因为一旦出现错误，Retrofit会自动抛出异常。比如，常见请求异常404，500，503等等。为了方便后期排查问题，这个可以在debug环境下打印日志就可以。
    - 2.在解析数据时，我们设置一个拦截器，判断Result里面的code是否为成功，如果不成功，则要根据与服务器约定好的错误码来抛出对应的异常。比如，token失效后跳转登录页面，禁用同账号登陆多台设备，缺少参数，参数传递异常等等。
    - 3.除此以外，为了我们要尽量避免在View层对错误进行判断，处理，我们必须还要设置一个拦截器，拦截onError事件，然后使用ExceptionUtils，让其根据错误类型来分别处理。
- 异常统一处理步骤
    - 第一步：定义请求接口网络层失败的状态码。常见比如400，404，500，502等。
    - 第二步，接口请求成功，业务层失败，服务端定义异常状态码
        - 比如，登录过期，提醒用户重新登录；
        - 比如，添加商品，但是服务端发现库存不足，这个时候接口请求成功，服务端定义业务层失败，服务端给出提示语，客户端进行吐司
        - 比如，请求接口，参数异常或者类型错误，请求code为200成功状态，不过给出提示，这个时候客户端用log打印服务端给出的提示语，方便快递查找问题
        - 比如，其他情况，接口请求成功，但是服务端定义业务层需要吐司服务端返回的对应提示语
    - 第三步，自定义Http层的异常和服务器定义的异常类
    - 第四步，统一处理异常逻辑如下所示


### 07.图片网络优化
- 比如我之前看到豆瓣接口，提供一种加载图片方式特别好。接口返回图片的数据有三种，一种是高清大图，一种是正常图片，一种是缩略小图。当用户处于wifi下给控件设置高清大图，当4g或者3g模式下加载正常图片，当弱网条件下加载缩略图【也称与加载图】。
- 简单来说根据用户的当前的网络质量来判断下载什么质量的图片（电商用的比较多）。豆瓣开源接口可以参考一下！





### 10.获取网络数据优化
- 移动端获取网络数据优化的几个点
- 连接复用：节省连接建立时间，如开启 keep-alive。
    - 对于Android来说默认情况下HttpURLConnection和HttpClient都开启了keep-alive。只是2.2之前HttpURLConnection存在影响连接池的Bug，具体可见：Android HttpURLConnection及HttpClient选择
- 请求合并：即将多个请求合并为一个进行请求，比较常见的就是网页中的CSS Image Sprites。如果某个页面内请求过多，也可以考虑做一定的请求合并。
- 减少请求数据的大小：对于post请求，body可以做gzip压缩的，header也可以做数据压缩(不过只支持http)
    - 返回数据的body也可以做gzip压缩，body数据体积可以缩小到原来的30%左右。（也可以考虑压缩返回的json数据的key数据的体积，尤其是针对返回数据格式变化不大的情况，支付宝聊天返回的数据用到了）




